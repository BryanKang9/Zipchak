<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.ChatMessageMapper">
    <select id="getChatMessage" parameterType="int" resultType="cmdto">
        SELECT cm.cm_num, cm.cr_num, cm.sender, cm.msg, cm.is_read, cm.cm_wdate,
               seller.ur_num seller_num,seller.prf_nick seller_nick, seller.prf_img seller_img,
               buyer.ur_num buyer_num, buyer.prf_nick buyer_nick, buyer.prf_img buyer_img from cm
            join cr on cr.cr_num=cm.cr_num
            join sp on cr.sp_num=sp.sp_num
            join ur_prf as seller on seller.ur_num=sp.ur_num
            join ur_prf as buyer on buyer.ur_num=cr.buyer_num
        where cm.cr_num=#{cr_num}
    </select>
    <insert id="insertChatMessage" parameterType="cmdto" useGeneratedKeys="true" keyProperty="cm_num" keyColumn="cm_num">
        insert into cm values (null, #{cr_num},#{sender},#{msg},0,now())
    </insert>
    <select id="getMsg" parameterType="int" resultType="cmdto">
        select * from cm where cm_num=#{cm_num}
    </select>
    <select id="getSender" parameterType="int" resultType="int">
        select sender from cm where cr_num=#{cr_num} order by cm_wdate desc limit 1
    </select>
    <update id="updateRead" parameterType="map">
        update cm set is_read=1 where cr_num=#{cr_num} and sender=#{sender}
    </update>
</mapper>